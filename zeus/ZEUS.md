# Forenote
If attempting to replicate below steps, **ADHERE TO CAUTION**. View Grant Collins' playlist (linked in the [README.md](https://github.com/mkathia/malware-analysis/edit/main/README.md) file) for a more detailed instruction set. 

# Project Overview
WIP

# Downloading the Malware
To obtain the malicious sample, we must temporarily provide our target system with internet access. To do so, we change it from the previous host-only adapter to a bridged adapter, as seen below.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/d8e501e5-0bd4-4465-802a-5d008df2ee19)

Then, we can download our malware from the Github page, as seen below.

![downloadingzeus](https://github.com/mkathia/malware-analysis/assets/113075504/d4226b68-bcab-445d-9b46-17f472ceac29)


# Extracting the Malware
With our malicious sample on the computer, we open the archive and view the file. We extract this file from the archive and place it on our desktop.

![extractingzeus](https://github.com/mkathia/malware-analysis/assets/113075504/4d7e4e99-973f-4c2b-970f-3419904a71c1)

# Fingerprinting

Our first step in analyzing this piece of malware is fingerprinting it. 

We can document the name of the malware: _invoice_2318362983713_823931342io.pdf.exe_
Note the double extension, this is used to take advantage of indiviudals who do not have their computers configured to view full file extensions.

Next, we provide it to a website known as VirusTotal, and see what the output provides.

![virustotaloutput](https://github.com/mkathia/malware-analysis/assets/113075504/bcc55c2c-0b96-4980-abbe-e2d396619a83)

Clearly, the file we have is malicious. The majority of security vendors flag this file. 

After doing this, we no longer need internet connection, so we immediately revert our changes to the internet to once again isolate the machines in their own network. Just to ensure connectivity, we re-ping the machines, as we did in the [README.md](https://github.com/mkathia/malware-analysis/edit/main/README.md) file. Once seeing that the connection is there, we know everything is well, and we can further proceed with our malware analysis.

Our next steps involve a software known as pestudio, a malware analysis tool. When we provide pestudio our malware, one of the first things seen is the hashes of the malware. These hashes will be documented. We can also document the first 64 bytes of the hex dump, and the fact that the first-bytes-text contains M Z, which denotes that this file is an executable.

![pestudiohash](https://github.com/mkathia/malware-analysis/assets/113075504/f6c8838b-7757-42f9-aba2-78591df90f90)

We can also look at the export section, which contains a domain, _corect.com_. 

![image](https://github.com/mkathia/malware-analysis/assets/113075504/f9cf4a74-ac2b-4608-b32a-d6ce62ab74e6)

Documenting this concludes our fingerprinting.

# Static Analysis

To begin our static analysis, we look through the "sections" tab. In this section, we can see the raw and virtual sizes of the executable. Malware authors sometimes "pack" their malware to obfuscate it and to deter analysis. This can be signified by a wildly differing raw and virtual size. Thankfully for us, we can see that the sizes are relatively similar, so the malware is not packed.

![pestudiosectionspacked](https://github.com/mkathia/malware-analysis/assets/113075504/c20da502-c6ce-4632-b1e3-6d2725bf2a20)

Next, we look through the "strings" tab. In this tab, we can see different strings utilized inside the executable. pestudio flags some of these strings, and when filtering by flags, we can easily view them. 

![pestudioflaggedstrings](https://github.com/mkathia/malware-analysis/assets/113075504/313df247-99d5-48a1-b18d-15a341bdb0f8)

These strings are to be documented. Furthermore, as we look through the rest of the strings, we can eventually see a pattern.

![pestudiokerneluser32](https://github.com/mkathia/malware-analysis/assets/113075504/ce0dcab3-6162-436a-a74a-19193ccad2ce)

The strings are alternating between junk lines and calls to either KERNEL32 or USER32. This is also intriguing, and should be documented.

Continuing on to the libraries section, we note that the three being called are SHLWAPI.dll, KERNEL32.dll, and USER32.dll

![image](https://github.com/mkathia/malware-analysis/assets/113075504/6602907d-154d-46f3-8d5a-b17f865d7c04)

This concludes our use of pestudio.

Next, we open cmder as an enhanced terminal, and run floss on our executable and redirect the output to a text file.

![floss_loading](https://github.com/mkathia/malware-analysis/assets/113075504/6de2266a-734a-4292-a14e-81deb227694b)

When looking at the output of this call, we search for .com and other domain names. We find a .com domain, _corect.com_. We encountered this domain previously, and thus it is already documented.

![flosscom](https://github.com/mkathia/malware-analysis/assets/113075504/bb4d3ed7-6c9f-417e-b0af-d0e505a91f60)

This concludes our use of floss.

Next, we proceed to use capa to anaylze the malware. The output provided is below.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/4ce9de21-96ed-4035-be88-33bddcf2e5a4)

capa attempts to map the malware's behavior to the MITRE Attack Framework. Thus, we can see that the attack tactic is _DEFENSE EVASION_, and the technique is _Virtualization/Sandbox Evasion_. It also mentions _ANTI-BEHAVIORAL ANALYSIS_, _Virtual Machine Detection_, and lists a few capabilities. 

We re-run capa with a -vv flag, which has capa attempt to find where in the code the aforementioned capabilities originate from. Output is below.

![capavv](https://github.com/mkathia/malware-analysis/assets/113075504/3f4ec19a-4527-4bd9-a017-670653f58116)

This concludes our use of capa. 

We proceed to analyze the domain that we found numerous times earlier, _corect.com_. We provide it to VirusTotal, and are shown that there is no malicious activity.
![image](https://github.com/mkathia/malware-analysis/assets/113075504/a467c06a-a244-4333-ab7d-dff781e0ba0a)

Next, we access the WayBackMachine, which takes snapshots of websites for archiving purposes. When we pick a random date in 2013, we see this.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/68fa9e3e-02fb-41af-b198-5631d6b25595)

Pasting text into Google Translate, we can see that this seems to be a news site. Thus, it can be concluded that the domain yields no results.

To continue our static analysis, we will be using Cutter. After giving it the file, we see a bunch of information that we have seen before, such as the hashes and the libraries. 

![cutterhomepage](https://github.com/mkathia/malware-analysis/assets/113075504/9338995b-738b-4aaf-b3ef-bbca7d465f5e)

However, it also offers us a view into the assembly, even in a graph view.

![cuttergraph](https://github.com/mkathia/malware-analysis/assets/113075504/7c13de25-590f-42dd-8a13-cef838fd7084)

Now, we can go into the strings section of the ouptut. What's given is similar to what we saw before in pestudio and floss. 

![image](https://github.com/mkathia/malware-analysis/assets/113075504/bd9881e4-faa2-4a90-b608-07bdcc9c7cc8)

However, here we can search up specific instances, such as the function calls we documented earlier. When we search up a function example, "CellrotoCrudUntohighCols", we find it.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/49afa0ea-f006-4dc3-acbe-1828722c04bd)

We can use this to jump to the code segment in the graph view.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/9c3e1fa9-1b4b-4811-8344-7048f289a22d)

The _ighC_ is a part of the function. Now that we know we can find the functions, we'll search for a kernel function, such as "KERNEL32.CreateFile". When we search for it, we find that the line _dec ebx_ is responsible for that function call. Note the proximity between _ighC_ and the kernel call. 

![image](https://github.com/mkathia/malware-analysis/assets/113075504/dd85a5a0-4285-445f-90fb-89c1bdccc073)

Given this, we can hypothesize that the jumbled strings of functions are obfuscated instances of the more sinister kernel calls. This concludes our static analysis.

# Dynamic Analysis

Before we begin our dynamic analysis, we double check that we do not have internet connection. Then, we have both machines re-ping each other to ensure connectivity. Then, we take a snapshot to have a clear machine state. After doing this, we can begin our dynamic analysis. 

The first tool we use is procmon (Process Monitor).

![image](https://github.com/mkathia/malware-analysis/assets/113075504/58ef3acf-2d46-4d14-9672-86cf0535c326)
![image](https://github.com/mkathia/malware-analysis/assets/113075504/d8e828b7-a01d-4089-8712-07cffa261b98)

After starting this tool, we run _inetsim_ on REMnux and confirm that our DNS service is running.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/f3c25999-6f92-40c4-b5fc-8855cdba7568)

To confirm this, on FlareVM we try to access any URL and see this page. 
![image](https://github.com/mkathia/malware-analysis/assets/113075504/9b03cb3d-44e6-4be7-9279-f77899dfc1be)

This is our confirmation that INetSim is working.

Finally, we detonate our malware. 

![image](https://github.com/mkathia/malware-analysis/assets/113075504/6dcf423c-6351-455d-86d2-c8de4af5ca1a)

Immediately, we see a screen asking for permissions. Naturally, we grant them.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/612d62a5-368a-4820-bc0c-a6b41b0eb41e)

It seems that the program downloaded something, than immediately deleted itself. We can assume that it has already begun it's damage on our system, and has established some method to remain persistent.

Upon accessing the process tree, we can see that the executable is still running, despite having deleted itself from the desktop. It's subprocesses include _InstallFlashPlayer.exe_ and _cmd.exe_.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/511fdf03-0993-41b2-a396-c36ae64343f3)


In the first subprocess, we can see that it's using the _Temp_ folder to host an executable.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/b24982ff-1a7f-4f78-b5f4-e57b92e50ddd)

In the second process, we can see a command run in the console.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/d2d3d135-07e3-4f3c-ace4-ea9a6b33f173)

Let us look at the _Temp_ folder.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/219e5964-d36d-4553-815f-5712e9a8d25d)

We can see the created executable, _InstallFlashPlayer.exe_. This is something we should take a deeper look at later. For now, we document what we learned from procmon.

Moving on, we look at procmon's filtering tools. The first thing we filter for is processes that contain the word "invoice". We also filter for Path's containing the Temp folder. After applying these filters, we see how many actions were taken by the invoice process.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/784fbd04-3a10-420c-be17-b095e8cb512a)

One of the things we notice is that something created/written to is msimg32.dll, which is something to take note of. 

![image](https://github.com/mkathia/malware-analysis/assets/113075504/d8ca080c-958a-4c76-891f-ea98d4557c27)

In the file explorer, we can see this dll file.

![image](https://github.com/mkathia/malware-analysis/assets/113075504/1ac76954-f43f-49b2-88f9-4256cec12100)

These files are ones to take note of for later. To remember, they are copied to the desktop.

We're going to add more filtering criteria to procmon, namely by operations. We're going to search for registry key modifications. The specific operations is called _RegSetValue_ .

![image](https://github.com/mkathia/malware-analysis/assets/113075504/9a4334c7-1a72-4fee-8c98-45e3807f47dd)
![image](https://github.com/mkathia/malware-analysis/assets/113075504/4ca450fc-0e7a-4544-a546-2ab468cbb837)

We notice some interesting processes, but one odd process is "Google Update". This is odd, and we don't know much about what's occuring here. This is to be noted.

This concludes our analysis with procmon. 

Next, we will be using wireshark to see if the malware is reaching out to a C2 server. 

We set Wireshark to monitor our ethernet.
![image](https://github.com/mkathia/malware-analysis/assets/113075504/49eb62df-6a6e-42a6-8b3f-4d5685c0e65f)

Then, we re-detonate our malware, and look for suspicious packets. We notice one here.
![image](https://github.com/mkathia/malware-analysis/assets/113075504/8aa1dbf5-4fda-40aa-8d42-cbfcdb8b4601)

This packet mentions flash player, which we have seen before. When looking through it, we see a hard-coded domain.
![image](https://github.com/mkathia/malware-analysis/assets/113075504/67bdcbc8-130c-4a65-acb8-6046feea4d81)

We see the domain more clearly when we follow the TCP stream.
![image](https://github.com/mkathia/malware-analysis/assets/113075504/994974b3-4728-4e79-ab34-d280affb5905)

When we search this domain on VirusTotal, it seems like most vendors see it as secure.
![image](https://github.com/mkathia/malware-analysis/assets/113075504/cf462198-dae3-4728-9fe9-a1f136437b0f)

Additionally, it cannot be found on the Wayback Machine. Regardless, this domain is worth taking note of. This will conclude our dynamic analysis.

# YARA (IOC)

